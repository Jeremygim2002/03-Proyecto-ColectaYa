// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// ENUMS - Estados del sistema ColectaYa MVP
// =====================================================

enum Role {
  USER  // Usuario regular
  ADMIN // Administrador del sistema
}

enum CollectionStatus {
  ACTIVE  // Activa, recibiendo aportes
  CLOSED  // Cerrada, no acepta m√°s aportes
  HIDDEN  // Oculta (borrador o pausada)
}

enum RuleType {
  GOAL_ONLY  // Solo retiro al 100% de meta
  THRESHOLD  // Retiro al alcanzar % umbral
  ANYTIME    // Retiro en cualquier momento
}

enum ContributionStatus {
  PAID     // Pagado exitosamente
  FAILED   // Pago fallido
  REFUNDED // Reembolsado
}

enum WithdrawalStatus {
  REQUESTED // Solicitado
  PAID      // Pagado
  REJECTED  // Rechazado
}

// =====================================================
// MODELOS - Entidades principales ColectaYa MVP
// =====================================================

model User {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique
  password  String
  roles     Role[]   @default([USER])
  createdAt DateTime @default(now()) @db.Timestamptz

  // Relaciones
  ownedCollections Collection[]        @relation("CollectionOwner")
  memberships      CollectionMember[]
  contributions    Contribution[]
  withdrawals      Withdrawal[]

  @@index([email])
  @@map("users")
}

model Collection {
  id           String           @id @default(uuid()) @db.Uuid
  ownerId      String           @db.Uuid
  title        String
  description  String?
  isPrivate    Boolean          @default(false)
  goalAmount   Decimal          @db.Decimal(12, 2)
  ruleType     RuleType
  thresholdPct Decimal?         @db.Decimal(5, 2) // Solo si ruleType=THRESHOLD
  status       CollectionStatus @default(ACTIVE)
  deadlineAt   DateTime?        @db.Timestamptz
  createdAt    DateTime         @default(now()) @db.Timestamptz

  // Relaciones
  owner         User               @relation("CollectionOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members       CollectionMember[]
  contributions Contribution[]
  withdrawals   Withdrawal[]

  @@index([ownerId])
  @@index([status])
  @@index([deadlineAt])
  @@map("collections")
}

model CollectionMember {
  id           String    @id @default(uuid()) @db.Uuid
  collectionId String    @db.Uuid
  userId       String    @db.Uuid
  invitedAt    DateTime? @db.Timestamptz
  acceptedAt   DateTime? @db.Timestamptz
  addedBy      String?   @db.Uuid

  // Relaciones
  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([collectionId, userId])
  @@index([collectionId])
  @@index([userId])
  @@map("collection_members")
}

model Contribution {
  id           String             @id @default(uuid()) @db.Uuid
  collectionId String             @db.Uuid
  userId       String?            @db.Uuid
  amount       Decimal            @db.Decimal(12, 2)
  status       ContributionStatus
  paymentRef   String?            // Referencia interna de pago
  createdAt    DateTime           @default(now()) @db.Timestamptz

  // Relaciones
  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  user       User?      @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([collectionId])
  @@index([userId])
  @@index([status])
  @@index([paymentRef])
  @@map("contributions")
}

model Withdrawal {
  id           String           @id @default(uuid()) @db.Uuid
  collectionId String           @db.Uuid
  requestedBy  String?          @db.Uuid
  amount       Decimal          @db.Decimal(12, 2)
  status       WithdrawalStatus @default(REQUESTED)
  createdAt    DateTime         @default(now()) @db.Timestamptz
  processedAt  DateTime?        @db.Timestamptz

  // Relaciones
  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  requester  User?      @relation(fields: [requestedBy], references: [id], onDelete: SetNull)

  @@index([collectionId])
  @@index([requestedBy])
  @@index([status])
  @@map("withdrawals")
}